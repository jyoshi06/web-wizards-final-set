<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OD Request System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script type="text/javascript" src="https://cdn.emailjs.com/sdk/3.2.0/email.min.js"></script>
  <style>
    /* --- Same CSS as before --- */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
    .container { width: 100%; max-width: 800px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); overflow: hidden; }
    header { background: #0066cc; color: white; padding: 20px; text-align: center; }
    header h1 { font-size: 28px; margin-bottom: 5px; }
    .content { padding: 25px; }
    .form-section { margin-bottom: 30px; }
    h2 { color: #0066cc; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eaeaea; }
    .form-row { display: flex; flex-wrap: wrap; margin: 0 -10px; }
    .form-group { flex: 1 0 calc(50% - 20px); margin: 0 10px 15px; min-width: 250px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
    input, textarea { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
    input:focus, textarea:focus { outline: none; border-color: #0066cc; box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2); }
    textarea { min-height: 100px; resize: vertical; }
    .button-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 25px; }
    button { padding: 14px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; flex: 1; min-width: 150px; display: flex; align-items: center; justify-content: center; }
    button i { margin-right: 8px; }
    .btn-generate { background: #4CAF50; color: white; }
    .btn-generate:hover { background: #3d8b40; }
    .btn-download { background: #2196F3; color: white; }
    .btn-download:hover { background: #0b7dda; }
    .btn-send { background: #9C27B0; color: white; }
    .btn-send:hover { background: #7b1fa2; }
    .btn-submit { background: #FF9800; color: white; }
    .btn-submit:hover { background: #e68a00; }
    .output-section { margin-top: 30px; }
    .letter-preview { background: #f9f9f9; border-radius: 8px; padding: 20px; border: 1px solid #eaeaea; white-space: pre-wrap; line-height: 1.6; max-height: 400px; overflow-y: auto; }
    .signature-area { margin-top: 30px; text-align: right; padding: 20px; border-top: 2px dashed #ddd; }
    .signature-line { width: 300px; border-top: 1px solid #333; margin: 40px 0 10px auto; text-align: center; padding-top: 5px; }
    .status-message { padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; font-weight: 500; }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    @media (max-width: 600px) { .form-group { flex: 1 0 100%; } .button-group { flex-direction: column; } button { width: 100%; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>OD Request System</h1>
      <p>Generate and send On-Duty request letters with approval workflow</p>
    </header>
    <div class="content">
      <!-- Student Info -->
      <div class="form-section">
        <h2>Student Information</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input type="text" id="name" required>
          </div>
          <div class="form-group">
            <label for="regno">Register Number</label>
            <input type="text" id="regno" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="yearsec">Year & Section</label>
            <input type="text" id="yearsec" required>
          </div>
          <div class="form-group">
            <label for="studentEmail">Your Email</label>
            <input type="email" id="studentEmail" required>
          </div>
        </div>
      </div>

      <!-- OD Details -->
      <div class="form-section">
        <h2>OD Request Details</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="purpose">Purpose of OD</label>
            <input type="text" id="purpose" required>
          </div>
          <div class="form-group">
            <label for="venue">Venue / Organization</label>
            <input type="text" id="venue" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="dates">Date(s)</label>
            <input type="text" id="dates" required>
          </div>
          <div class="form-group">
            <label for="time">Time</label>
            <input type="text" id="time" required>
          </div>
        </div>
        <div class="form-group">
          <label for="additionalInfo">Additional Information (Optional)</label>
          <textarea id="additionalInfo"></textarea>
        </div>
      </div>

      <!-- Approval Workflow -->
      <div class="form-section">
        <h2>Approval Workflow</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="mentorEmail">Mentor Email</label>
            <input type="email" id="mentorEmail" required>
          </div>
          <div class="form-group">
            <label for="hodEmail">HOD Email</label>
            <input type="email" id="hodEmail" required>
          </div>
        </div>
        <div id="statusMessage" class="status-message info">Please fill all details and generate your OD request letter</div>
        <div class="button-group">
          <button class="btn-generate" onclick="generateLetter()"><i>ðŸ“„</i> Generate Letter</button>
          <button class="btn-download" onclick="downloadPDF()"><i>ðŸ“¥</i> Download PDF</button>
          <button class="btn-send" onclick="sendEmail()"><i>âœ‰</i> Send via Email</button>
          <button class="btn-submit" onclick="submitRequest()"><i>âœ…</i> Submit OD Request</button>
        </div>
      </div>

      <!-- Preview -->
      <div class="output-section">
        <h2>Letter Preview</h2>
        <div class="letter-preview" id="output">Your OD request letter will appear here...</div>
        <div class="signature-area">
          <p>Approved by:</p>
          <div class="signature-line"><p>Authorized Signatory</p></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let generatedText = "";
    let pdfBase64 = "";
    let requestId = "";

    // ðŸ”¹ Initialize EmailJS
    (function() {
      emailjs.init("YOUR_PUBLIC_KEY"); // Replace with your EmailJS Public Key
    })();

    function generateRequestId() {
      const timestamp = new Date().getTime().toString(36);
      const randomStr = Math.random().toString(36).substring(2, 8);
      return OD-$`{timestamp}-${randomStr}`.toUpperCase();
    }

    function generateLetter() {
      const name = document.getElementById("name").value;
      const regno = document.getElementById("regno").value;
      const yearsec = document.getElementById("yearsec").value;
      const purpose = document.getElementById("purpose").value;
      const dates = document.getElementById("dates").value;
      const time = document.getElementById("time").value;
      const venue = document.getElementById("venue").value;
      const additionalInfo = document.getElementById("additionalInfo").value;

      if (!name || !regno || !yearsec || !purpose || !dates || !time || !venue) {
        showStatus("Please fill all required fields", "error");
        return;
      }

      requestId = generateRequestId();
      generatedText =
`ON-DUTY REQUEST LETTER
Request ID: ${requestId}

To,
The Head of Department,
Department of Computer Science,
DS University.

Respected Madam,

I, ${name} (Register No: ${regno}), a student of ${yearsec}, would like to request permission for On-Duty (OD) leave for the following:

Purpose: ${purpose}
Date(s): ${dates}
Time: ${time}
Venue/Organization: ${venue}
${additionalInfo ?` Additional Information: ${additionalInfo}` : ''}

I request you to kindly grant me permission to attend the above-mentioned event and approve my OD request.

Thank you for your consideration.

Yours sincerely,
${name}
${regno}
${yearsec}`;

      document.getElementById("output").innerText = generatedText;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("helvetica", "normal");
      doc.setFontSize(16);
      doc.text("ON-DUTY REQUEST LETTER", 105, 20, { align: "center" });
      doc.setFontSize(12);
      doc.text(`Request ID: ${requestId}`, 105, 30, { align: "center" });
      const splitText = doc.splitTextToSize(generatedText, 170);
      doc.text(splitText, 20, 45);
      pdfBase64 = doc.output("datauristring");

      showStatus("OD request letter generated successfully!", "success");
    }

    function downloadPDF() {
      if (!generatedText) {
        showStatus("Please generate the letter first!", "error");
        return;
      }
      const link = document.createElement("a");
      link.href = pdfBase64;
      link.download = "OD_Request_Letter.pdf";
      link.click();
      showStatus("PDF downloaded successfully!", "success");
    }

    function sendEmail() {
      if (!generatedText) {
        showStatus("Please generate the letter first!", "error");
        return;
      }

      const templateParams = {
        student_name: document.getElementById("name").value,
        regno: document.getElementById("regno").value,
        yearsec: document.getElementById("yearsec").value,
        request_id: requestId,
        od_letter: generatedText,
        mentor_email: document.getElementById("mentorEmail").value,
        hod_email: document.getElementById("hodEmail").value,
        student_email: document.getElementById("studentEmail").value
      };

      emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", templateParams)
        .then(() => {
          showStatus("Emails sent successfully to Mentor and HOD!", "success");
        }, (error) => {
          console.error("EmailJS Error:", error);
          showStatus("Failed to send emails. Please try again.", "error");
        });
    }

    function submitRequest() {
      if (!generatedText) {
        showStatus("Please generate the letter first!", "error");
        return;
      }
      showStatus(`OD request submitted successfully! Request ID: ${requestId}.`, "success");
    }

    function showStatus(message, type) {
      const statusElement = document.getElementById("statusMessage");
      statusElement.textContent = message;
      statusElement.className = "status-message " + type;
    }
  </script>
</body>
</html>